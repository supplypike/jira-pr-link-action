{"version":3,"sources":["../src/main.ts","../src/pr.ts","../src/jira.ts","../src/options.ts"],"sourcesContent":["import * as github from '@actions/github'\nimport * as core from '@actions/core'\nimport { process } from './pr'\n\nexport async function main(): Promise<void> {\n  try {\n    await process(github.context)\n  } catch (error) {\n    core.error(`Error caught in main: ${error}`)\n  }\n}\n\nmain()\n","import * as core from '@actions/core'\nimport type { Context } from '@actions/github'\nimport type { PullRequestEvent } from '@octokit/webhooks-types'\nimport { JiraClientImpl } from './jira'\nimport { getInput, type Options } from './options'\n\nexport async function process(\n  context: Context,\n  isValid = validate,\n): Promise<void> {\n  if (context.eventName !== 'pull_request') {\n    core.debug('Not a pull request')\n    return\n  }\n\n  const ev = context.payload as PullRequestEvent\n  const valid = await isValid(ev, getInput())\n\n  if (!valid) {\n    core.setFailed(\n      'Invalid Pull Request: missing JIRA project in title or branch',\n    )\n  }\n}\n\n/**\n * Pull requests are linked automatically if the issue key is included in the pull request's title or in the source branch name\n * @param event github pull request\n * @param project jira project, can be regex\n * @returns true if valid link to jira\n */\nexport async function validate(\n  event: PullRequestEvent,\n  options: Options,\n): Promise<boolean> {\n  const { project } = options\n  const re = RegExp(`(${project}-[0-9]+)+`, 'g')\n\n  const jira = new JiraClientImpl(options.jira)\n\n  core.debug(`author ${event.pull_request.user.login.toLowerCase()}`)\n  core.debug(`title ${event.pull_request.title}`)\n  core.debug(`head ${event.pull_request.head.ref}`)\n\n  for (const author of options.ignoreAuthor) {\n    if (event.pull_request.user.login.toLowerCase() === author.toLowerCase()) {\n      return true\n    }\n  }\n\n  const titleMatch = event.pull_request.title.match(re) || []\n  const refMatch = event.pull_request.head.ref.match(re) || []\n  const matches = [...titleMatch, ...refMatch]\n\n  if (matches.length < 1) {\n    core.error(`No Jira issue found for ${project} in PR title or branch`)\n    return false\n  }\n\n  for (const match of matches) {\n    core.debug(`Checking Jira issue ${match}`)\n    const exists = await jira.issueExists(match)\n    if (!exists) {\n      core.error(`Issue does not exist: ${match}`)\n      return false\n    }\n  }\n\n  return true\n}\n","import { Version3Client } from 'jira.js'\nimport * as core from '@actions/core'\nexport interface JiraConfig {\n  host: string\n  email: string\n  apiToken: string\n}\n\nexport interface JiraClient {\n  issueExists: (issueIdOrKey: string) => Promise<boolean>\n}\n\nexport class JiraClientImpl implements JiraClient {\n  private readonly client: Version3Client\n\n  constructor({ host, email, apiToken }: JiraConfig) {\n    this.client = new Version3Client({\n      host,\n      authentication: {\n        basic: {\n          email,\n          apiToken,\n        },\n      },\n    })\n  }\n\n  async issueExists(issueIdOrKey: string): Promise<boolean> {\n    try {\n      await this.client.issues.getIssue({ issueIdOrKey })\n      return true\n    } catch (error) {\n      core.debug(`getIssue error: ${error}`)\n      return false\n    }\n  }\n}\n","import * as core from '@actions/core'\nimport type { JiraConfig } from './jira'\n\nexport interface Options {\n  project: string\n  ignoreAuthor: string[]\n  jira: JiraConfig\n}\n\nexport function getInput(): Options {\n  const project = core.getInput('project', { required: true })\n  const ignoreAuthor = core.getMultilineInput('ignore-author') || []\n  const jiraHost = core.getInput('jira-host', { required: true })\n  const jiraEmail = core.getInput('jira-email', { required: true })\n  const jiraToken = core.getInput('jira-api-token', { required: true })\n\n  return {\n    project,\n    ignoreAuthor,\n    jira: {\n      host: jiraHost,\n      email: jiraEmail,\n      apiToken: jiraToken,\n    },\n  }\n}\n"],"mappings":"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","names":["core","core","error","core","getInput","context","getInput","error"]}